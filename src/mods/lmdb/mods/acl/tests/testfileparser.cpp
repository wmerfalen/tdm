#define CATCH_CONFIG_MAIN
#include "../../catch.hpp"
#include "../config-parser.hpp"
#include "../../util-conf.hpp"

void dump2file(const unsigned char* genstr,const char* file_name){
    unsigned int i = 0;
    FILE * fp = fopen(file_name,"w");
    while(genstr[i] != 0x00){
        fputc(genstr[i++],fp);
    }
    fclose(fp);
}
SCENARIO("config file is present","[fileparser]"){
    GIVEN("config file has valid syntax"){
        WHEN("rule is present"){
            THEN("a valid ruleset should be built and can be retrieved"){
                mods::util::conf::stfu = false;
                using namespace mods::acl;
                FileParser parser;
                parser.setFile("/etc/foo/bar/non/existent/file");
                int ret = parser.parse();
                REQUIRE(ret == FileParser::FILE_CANNOT_OPEN);
            }
            THEN("a valid parse should return a non-negative/non-zero return value"){
                using namespace mods::acl;
                FileParser parser;
                parser.print_debug = true;
                /*


# This is a comment
# lol
######

-playable
    deny ->
        files: [
            act.wizard.c
            main.c
            foo.c
        ]       
        commands: [
            shutdown
        ]
    allow ->
        files: [
            act.offensive.c
        ]
        */

#define VALID_CONF_FILE "/tmp/circlemud-acl_conf-valid-syntax.conf"
                const unsigned char genstr[] = {
                    0x0A,0x23,0x20,0x54,0x68,0x69,0x73,0x20,0x69,0x73,0x20,0x61,0x20,0x63,0x6F,0x6D,0x6D,0x65,0x6E,0x74,0x0A,0x23,0x20,0x6C,0x6F,0x6C,0x0A,0x23,0x23,0x23,
                    0x23,0x23,0x23,0x0A,0x0A,0x2D,0x70,0x6C,0x61,0x79,0x61,0x62,0x6C,0x65,0x0A,0x20,0x20,0x20,0x20,0x64,0x65,0x6E,0x79,0x20,0x2D,0x3E,0x0A,0x20,0x20,0x20,
                    0x20,0x20,0x20,0x20,0x20,0x66,0x69,0x6C,0x65,0x73,0x3A,0x20,0x5B,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x61,0x63,0x74,0x2E,
                    0x77,0x69,0x7A,0x61,0x72,0x64,0x2E,0x63,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x6D,0x61,0x69,0x6E,0x2E,0x63,0x0A,0x20,0x20,
                    0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x66,0x6F,0x6F,0x2E,0x63,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x5D,0x20,0x20,0x20,0x20,0x20,
                    0x20,0x20,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x63,0x6F,0x6D,0x6D,0x61,0x6E,0x64,0x73,0x3A,0x20,0x5B,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
                    0x20,0x20,0x20,0x20,0x20,0x73,0x68,0x75,0x74,0x64,0x6F,0x77,0x6E,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x5D,0x0A,0x20,0x20,0x20,0x20,0x61,0x6C,
                    0x6C,0x6F,0x77,0x20,0x2D,0x3E,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x66,0x69,0x6C,0x65,0x73,0x3A,0x20,0x5B,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,
                    0x20,0x20,0x20,0x20,0x20,0x20,0x61,0x63,0x74,0x2E,0x6F,0x66,0x66,0x65,0x6E,0x73,0x69,0x76,0x65,0x2E,0x63,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
                    0x5D,0x0A,0x00};
                dump2file(genstr,VALID_CONF_FILE);
                parser.setFile(VALID_CONF_FILE);
                int ret = parser.parse();
                parser.dump_tree();
                REQUIRE(ret > 0);
            }
        }
    }
    GIVEN("a config file with an invalid syntax"){
        WHEN("an attempt is made to parse"){
            THEN("parse will return a negative value"){
                using namespace mods::acl;
                FileParser parser;


                /*
# This is a comment
# lol
######

- playable
    deny ->
        files: 
            act.wizard.c
            main.c
            foo.c
        ]       
       : [
            shutdown
        ]
    allw ->
        files: [
            act.offensive.c
       */ 


const unsigned char genstr[] = {
			0x0A,0x23,0x20,0x54,0x68,0x69,0x73,0x20,0x69,0x73,0x20,0x61,0x20,0x63,0x6F,0x6D,0x6D,0x65,0x6E,0x74,0x0A,0x23,0x20,0x6C,0x6F,0x6C,0x0A,0x23,0x23,0x23,
			0x23,0x23,0x23,0x0A,0x0A,0x2D,0x20,0x70,0x6C,0x61,0x79,0x61,0x62,0x6C,0x65,0x0A,0x20,0x20,0x20,0x20,0x64,0x65,0x6E,0x79,0x20,0x2D,0x3E,0x0A,0x20,0x20,
			0x20,0x20,0x20,0x20,0x20,0x20,0x66,0x69,0x6C,0x65,0x73,0x3A,0x20,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x61,0x63,0x74,0x2E,
			0x77,0x69,0x7A,0x61,0x72,0x64,0x2E,0x63,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x6D,0x61,0x69,0x6E,0x2E,0x63,0x0A,0x20,0x20,
			0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x66,0x6F,0x6F,0x2E,0x63,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x5D,0x20,0x20,0x20,0x20,0x20,
			0x20,0x20,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3A,0x20,0x5B,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x73,0x68,0x75,0x74,
			0x64,0x6F,0x77,0x6E,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x5D,0x0A,0x20,0x20,0x20,0x20,0x61,0x6C,0x6C,0x77,0x20,0x2D,0x3E,0x0A,0x20,0x20,0x20,
			0x20,0x20,0x20,0x20,0x20,0x66,0x69,0x6C,0x65,0x73,0x3A,0x20,0x5B,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x61,0x63,0x74,0x2E,
			0x6F,0x66,0x66,0x65,0x6E,0x73,0x69,0x76,0x65,0x2E,0x63,0x0A,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x0A,0x00};
                unsigned i = 0;
#define INVALID_CONF_FILE "/tmp/circlemud-acl_conf-invalid-syntax.conf"
                dump2file(genstr,INVALID_CONF_FILE);
                parser.setFile(INVALID_CONF_FILE);
                REQUIRE(parser.parse() < 0);
            }
        }
    }
    GIVEN("constructor is supplied a file name"){
        WHEN("file can be opened"){
            THEN("This should succeed but that doesnt guarantee a valid syntax"){

            }
        }
        WHEN("File cannot be opened"){
            THEN("client code should not be able to parse the file"){

            }
        }
    }
};
